# 狗项圈协议
# 目录

* [1. 硬件构成](#id-section1)
* [2. 从设备地址](#id-section2)
	* [2.1 获取从设备地址](#id-section3)
	* [2.2 主模块点名](#id-section4)
* [3. 通信协议](#id-section5)
	* [3.1 帧格式](#id-section6)
	* [3.2 主模块命令](#id-section7)
		* [3.2.1 Call the roll - 0x01](#id-section8)
		* [3.2.2 Token - 0x02](#id-section9)
		* [3.2.3 Master Data - 0x03](#id-section10)
		* [3.2.4 Slave Data - 0x04](#id-section11)
	* [3.3 子命令](#id-section12)
		* [3.3.1 模块控制命令 - 0x01](#id-section13)
		* [3.3.2 透明上传命令 - 0x02](#id-section14)

<div id='id-section1'/>
## 1. 硬件构成

狗项圈主从模块的主要通信拓扑参考环形网络，即数据传输为单方向传输，采用100kHz I2C总线进行数据收发。

项圈五条线路，包括GND, VCC, SDA, SCL，AVOLT。其中SDA，SCL为I2C总线，AVOLT为高阻值的电阻线，设备需要根据连接所在位置的具体电压值来确认子的I2C地址。

协议将分为两个部分阐述。第一个部分为确定从设备I2C地址的解决方案，第二个部分为该通信应用层相关协议内容。

<div id='id-section2'/>
## 2. 从设备地址

使用I2C总线在狗项圈项目中最主要的问题为如何确定各个从设备的I2C地址。I2C总线由SCL，SDA双线组成。其中SCL为系统时钟线，SDA为数据线。两根线都由上拉电阻拉高。同时，连接到总线上的设备SCL, SDA均采用开漏输出模式。所以当同时有设备拉高、拉低总线时，总线会呈低电平状态。

通过实现AVOLT线路，让设备能够获得一个项圈内“唯一”的设备地址。并能让主模块获得各个从模块的位置信息。

<div id='id-section3'/>
### 2.1 获取从模块地址
项圈在开机之后的0-50ms预留给所有设备启动，并获取本机I2C地址。从设备需要读取当前连接位置AVOLT线上电压值，并通过8位ADC量化。该8位电压值即是设备的I2C通信地址。

因为每个从模块在物理上具备一个最小宽度，所以两个相邻的从模块在AVOLT线路上都会有一个最小电压差，即是最小地址差。利用这个最小地址差可以加快开机进程。

最小地址差应该定义为:
```c++
// 定义最小地址距离
#define DCOLLA_MIN_ADDR_DIS 20
```

实现过程如[链接](https://www.draw.io/#W4c1ef711f6e94fd3!6473)所示。

<div id='id-section4'/>
### 2.2 主模块点名
项圈在开机50ms后，主模块将点名，并由此确定项圈上的模块总数以及物理位置关系，形成地址表。点名从0x00开始，点到0xFF。当点到地址存在设备时，设备需要回复主模块，并附加模块自身属性信息。主设备在收到回复后需要记录信息并继续点名。通过最小地址差可以加快点名速度。

实现过程详见2.1当中所附[链接](https://www.draw.io/#W4c1ef711f6e94fd3!6473)。

地址分配完成后，I2C通信所需要的所有条件都将具备。之后系统进入正常工作状态。

<div id='id-section5'/>
## 3. 通信协议
设备当中的主从模块通信是在I2C基础上的一个自定应用层协议。协议的设计考虑了不同数据、控制命令的传输需求，以及对固件升级的支持，将来开发的扩展性的支持。主模块通过I2C协议当中的Slave Address字段控制通信对象，用轮询的方式同不同模块通信。

从网络拓扑来看，所有从模块类似于一个数据中心，或者服务器，由主模块轮询从模块并从从模块请求数据。所有数据发送也由主模块掌握逻辑。从模块不发起任何通信。主设备会在总线建立后对所有设备通过Token命令轮询。接收到Token命令的设备可以通过回复主设备的Token命令向主设备或其他从模块传输数据。

Slave Address的获取细节在第2章节中有提到。I2C包络中Slave Address之后的数据内容就是本协议所需要确立的帧格式以及各种控制命令。


<div id='id-section6'/>
### 3.1 帧格式
本小节讨论的帧格式为I2C数据包络当中的帧格式内容。




从模块地址 | W | 控制命令 | W/R | 数据包
---|---|---|---|---
7 bits |1 bit |7 bits |1 bit |N bits


其中，从模块地址为上文讨论中确定的Slave Address，从模块地址后跟随的为Write位，之后为控制命令。根据不同的控制命令可分为读、写两种命令。若为读取命令，则为从设备发送数据；若为写命令，则为主设备发送信息到从设备。

根据不同的控制命令，数据包中可能包含子命令。下文将帧格式当中提到的控制命令在 [3.2 主模块命令](<div id='id-section7'/>)当中分类讨论，将数据包中可能包含的子命令在 [3.3 子命令]()当中进行讨论。

每一次I2C通信发起只能包括一个控制命令。

<div id='id-section7'/>
### 3.2 主模块命令
由于所有通信都由主设备发起，从设备仅做应答。从模块之间的通信需要由主模块协助完成。本节主要讨论

<div id='id-section8'/>
#### 3.2.1 Call the roll - 0x01
点名命令。在系统建立地址列表之后，主设备通过Call the roll命令点名，并获取各模块的基本信息。当从模块被点名后，需要按如下所述数据包格式回复数据：


|模块功能代号|模块软件版本号|模块硬件版本号|模块数据量|模块生产厂商代码|模块生产日期|
|---|---|---|---|---|---|
|1 byte|1 byte|1 byte|1 byte|1 byte|8 bytes|


其中，具体代号规定如下：
* 功能模块代号：
从模块需要告知主模块自身功能代号，以保障系统功能。具体功能模块及功能代号如下表所示。


|功能模块名称|模块功能代号|
|---|---|
|主模块|0x01|
|健康模块|0x02|
|电池模块|0x03|
|LED模块|0x04|
|摄像头模块|0x05|
|人狗交互模块|0x06|


* 模块软件版本代号
软件版本号记录了从模块对应的软件（固件）版本号。该版本号可以作为系统升级等用途。初始版本号应为0x01，版本号不应为0xFF。

* 模块硬件版本号
硬件版本号记录了该功能模块的硬件版本号。该版本号用以为检索提供必要信息。初始版本号应为0x01，版本号不应为0xFF。在检索系统中，硬件版本号与功能模块代号共同形成检索号。如硬件版本号为0x03的健康模块，其硬件检索号应为0x0203。

* 模块数据量
因为不同模块有不同的数据传输需求，所以设置模块数据量字段用来通知主控模块该从模块的具体数据量。该字段为 1-10 的单字节数字，具体含义为每次主模块轮询到该从模块时，该从模块能够发送的命令数量。通过这种办法，可以让具有较大数据量的从模块在接收到Token之后能够发送较多的数据。

* 模块生产厂商代码 
生产厂商代码确定了具体的生产厂商地址。（待明确）

* 模块生产日期
模块的硬件生产日期。应通过UNIX时间戳格式记录。如2015年12月10日，7时4分00秒应表示为 0x00000000566923E0。

主模块在接收到相应信息后必须将信息存在内部flash，已备检索。

<div id='id-section9'/>
#### 3.2.2 Token - 0x02
基础的Token命令。主设备通过Token命令让接收到Token命令的从设备可以与其他主、从模块通信。从设备在收到Token命令之后，可以向主模块或其他从模块传输数据，也可以回复ACK声明无数据发送需求。

为降低通信的延时，每个设备被轮询到后只允许发送固定数量命令。主模块在协助从模块处理该命令后将轮询下一个设备。如果从设备有多个任务待处理，其需要等到下次轮询再发送。

因为不同模块的具体数据量有区别，所以在call the roll命令当中要求每个设备上报数据量。该数据量决定每次轮询时该模块几个命令。如上文所述，单次轮询可以传输的命令数量为 1-10 个。主模块在接收到数据量规定的命令后或者收到从模块无命令的ACK之后，对该从模块的轮询结束。

从设备回复的Token命令的数据格式应满足下述要求

总格式：

从模块地址 | W | 控制命令 | W/R | 数据包
---|---|---|---|---
7 bits |1 bit |7 bits |1 bit |N bits

数据包中格式：

|子命令|目的地址|子数据长度|子数据|
|---|---|---|---|
|1 byte|1 byte|2 bytes|N bytes|


<div id='id-section10'/>
#### 3.2.3 Master Data - 0x03
主模块数据命令。主设备通过Master Data命令向单一从模块传输一个从主设备下发的命令、数据。该命令的W/R必须选择为W。接受到该命令的从模块需要接收数据并根据命令做出相应相应。

在Master Data命令中，数据包具有如下格式：

总格式：

从模块地址 | W | 控制命令 | W/R | 数据包
---|---|---|---|---
7 bits |1 bit |7 bits |1 bit |N bits

数据包中格式：

|子命令|来源地址|来源模块功能号|子数据长度|子数据|
|---|---|---|---|---|
|1 byte|1 byte|1 byte|2 bytes|N bytes|


其中，来源地址固定为0x00,。

<div id='id-section11'/>
#### 3.2.4 Slave Data - 0x04
从模块数据命令。主设备通过Slave Data命令向一个从模块传输来自于另一个从模块的数据、命令。该命令的W/R必须选择为W。接受到该命令的从模块需要接收数据并根据命令做出相应相应。

在Master Data命令中，数据包具有如下格式：

总格式：

从模块地址 | W | 控制命令 | W/R | 数据包
---|---|---|---|---
7 bits |1 bit |7 bits |1 bit |N bits

数据包中格式：

|子命令|来源地址|来源模块功能号|子数据长度|子数据|
|---|---|---|---|---|
|1 byte|1 byte|1 byte|2 bytes|N bytes|


<div id='id-section12'/>
### 3.3 子命令
子命令是Master Data, Slave Data帧当中所包含的子命令字段。具体命令包含如下几种：

<div id='id-section13'/>
#### 3.3.1 模块控制命令 - 0x01
模块控制命令为控制模块功能的命令。其中，子数据为两个部分固定长度。第一个部分为一个字节的第二子命令，为具体控制类型。第二个部分为控制命令相关数据。相关第二子命令及数据表示如下表。

|第二子命令名称|第二子命令|控制命令相关数据|
|---|---|---|
|模块唤醒|0x01| - |
|模块休眠|0x02| - |
|模块高精度状态|0x03|-|
|模块低精度状态|0x04|-|

<div id='id-section14'/>
#### 3.3.2 透明上传命令 - 0x02
该命令用以传输主模块不需要处理，仅需要做缓存的数据。主模块在收到该命令后，仅需缓存该数据。待蓝牙连接、同步时将数据上报到上位机即可。
